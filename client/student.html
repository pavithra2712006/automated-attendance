<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Management - Attendance App</title>
    <script src="/_sdk/element_sdk.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <style>
      body {
        box-sizing: border-box;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
      }

      #wrapper {
        min-height: 100%;
        width: 100%;
      }

      .student-photo {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }

      .sidebar {
        width: 280px;
        min-height: 100vh;
        position: sticky;
        top: 0;
        background-color: #ffffff;
        font-size: 20px;
        flex-shrink: 0;
      }

      .main-content-wrapper {
        width: 100%;
        overflow-x: auto;
      }

      .txt {
        color: #6b7280;
        font-size: 18px;
      }

      .nav-link {
        padding: 12px 16px;
        border-radius: 8px;
        transition: background-color 0.3s;
      }

      .nav-link:hover {
        background-color: #f3f4f6;
      }

      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .btn-sm {
        font-size: 12px;
        padding: 4px 8px;
        margin: 2px;
      }

      .action-buttons {
        white-space: nowrap;
      }

      /* Mobile responsive styles */
      @media (max-width: 768px) {
        .sidebar {
          width: 100%;
          min-height: auto;
          position: relative;
          font-size: 16px;
        }

        #wrapper {
          flex-direction: column;
        }

        .student-photo {
          width: 30px;
          height: 30px;
        }

        .table {
          font-size: 12px;
        }

        .table th,
        .table td {
          padding: 8px 4px;
          white-space: nowrap;
        }

        .btn-sm {
          font-size: 10px;
          padding: 3px 6px;
          margin: 1px;
        }

        h2 {
          font-size: 24px;
        }

        h4 {
          font-size: 18px;
        }
      }

      @media (max-width: 576px) {
        .sidebar {
          font-size: 14px;
          padding: 15px;
        }

        .sidebar h3 {
          font-size: 20px;
        }

        .table {
          font-size: 11px;
        }

        .filter-label {
          font-size: 13px;
        }

        .form-select {
          font-size: 13px;
          padding: 6px;
        }
      }
    </style>

    <style>
      @view-transition {
        navigation: auto;
      }
    </style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
  </head>

  <body>
    <script>
      const userType = localStorage.getItem("userType");

      if (!userType) {
        window.location.href = "login.html";
      }

      if (userType === "student" || userType === "faculty") {
        window.location.href = "attendance.html";
      }
    </script>
    <div class="d-flex" id="wrapper" style="background-color: #f7fafc">
      <!-- Sidebar -->
      <div class="text-black p-4 sidebar card">
        <h3 class="p-1" style="margin-left: 10px">e-Haazri</h3>
        <p class="txt" style="margin-left: 10px">College Dashboard</p>
        <hr />
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link text-black" href="overview.html">
              <i class="bi bi-house-door-fill me-2"></i>Overview
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-black" href="student.html">
              <i class="bi bi-people-fill me-2"></i>Students
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-black" href="faculty.html">
              <i class="bi bi-person-badge-fill me-2"></i>Faculty
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-black" href="attendance.html">
              <i class="bi bi-calendar-check-fill me-2"></i>Attendance
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-black" href="login.html">
              <i class="bi bi-box-arrow-right me-2"></i>Logout
            </a>
          </li>
        </ul>
      </div>

      <!-- Main content -->
      <div class="p-3 main-content-wrapper" style="margin-left: 20px">
        <div class="row">
          <div class="col-md-9 col-12 mb-3">
            <h2 style="font-size: 30px; font-weight: 500">
              Student Management
            </h2>
            <p class="txt">
              Manage student profiles for Jeppiaar Institute of Technology |
              <span id="currentDate"></span>
            </p>
          </div>
          <div class="col-md-3 col-12">
            <button
              style="
                background-color: #0b3d91;
                border-radius: 8px;
                padding: 10px;
                border: none;
                width: 150px;
              "
              class="text-white"
              data-bs-toggle="modal"
              data-bs-target="#studentModal"
            >
              + New Student
            </button>
          </div>
        </div>

        <br />

        <!-- Total Students card -->
        <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-3">
          <div class="card p-3">
            <div class="row align-items-center">
              <div class="col-8">
                <h5 class="mb-0" style="font-size: 20px">
                  Total Students <br />
                  <span id="studentCount" class="fs-4 fw-bold">0</span>
                </h5>
              </div>
              <div class="col-4 text-end">
                <i
                  class="bi bi-people-fill"
                  style="color: #0b3d91; font-size: 2.8rem"
                ></i>
              </div>
            </div>
          </div>
        </div>

        <br />

        <!-- Student List Table -->
        <div class="card" style="border-radius: 10px">
          <h4
            class="p-3"
            style="color: #000000; font-size: 22px; font-weight: 600"
          >
            Student List
          </h4>

          <div class="container-fluid px-3">
            <div class="row g-3 mb-3">
              <!-- Year Filter -->
              <div class="col-lg-3 col-md-6 col-12">
                <label for="yearFilter" class="filter-label"
                  >Filter by Year</label
                >
                <select class="form-select" id="yearFilter">
                  <option value="all">All Years</option>
                  <option value="I">I</option>
                  <option value="II">II</option>
                  <option value="III">III</option>
                  <option value="IV">IV</option>
                </select>
              </div>

              <!-- Class Filter -->
              <div class="col-lg-3 col-md-6 col-12">
                <label for="classFilter" class="filter-label"
                  >Filter by Class</label
                >
                <select class="form-select" id="classFilter">
                  <option value="all">All Classes</option>
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                </select>
              </div>
            </div>
          </div>

          <div class="table-responsive px-3 pb-3">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th style="background-color: #0b3d91" class="text-white">
                    Photo
                  </th>
                  <th style="background-color: #0b3d91" class="text-white">
                    Student ID
                  </th>
                  <th style="background-color: #0b3d91" class="text-white">
                    Name
                  </th>
                  <th style="background-color: #0b3d91" class="text-white">
                    Class
                  </th>
                  <th style="background-color: #0b3d91" class="text-white">
                    Year
                  </th>
                  <th style="background-color: #0b3d91" class="text-white">
                    Department
                  </th>
                  <th style="background-color: #0b3d91" class="text-white">
                    Parent Name
                  </th>
                  <th style="background-color: #0b3d91" class="text-white">
                    Contact
                  </th>
                  <th style="background-color: #0b3d91" class="text-white">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody id="studentTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="studentModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form id="studentForm">
            <div class="modal-header">
              <h5 class="modal-title" id="modalTitle">Add Student</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <input
                id="fPhoto"
                type="file"
                class="form-control mb-2"
                accept="image/*"
              />
              <input
                id="fStudentId"
                class="form-control mb-2"
                placeholder="Student ID"
                required
              />
              <input
                id="fName"
                class="form-control mb-2"
                placeholder="Student Name"
                required
              />
              <select id="fClass" class="form-select mb-2" required>
                <option value="">Select Class</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
              </select>
              <select id="fYear" class="form-select mb-2" required>
                <option value="">Select Year</option>
                <option value="I">I</option>
                <option value="II">II</option>
                <option value="III">III</option>
                <option value="IV">IV</option>
              </select>
              <!-- NEW Department field -->
              <select id="fDepartment" class="form-select mb-2" required>
                <option value="">Select Department</option>
                <option value="CSE">CSE</option>
                <option value="IT">IT</option>
                <option value="ECE">ECE</option>
                <option value="MECH">MECH</option>
              </select>
              <input
                id="fParentName"
                class="form-control mb-2"
                placeholder="Parent Name"
                required
              />
              <input
                id="fContact"
                type="tel"
                class="form-control mb-2"
                placeholder="Contact Number"
                required
              />
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- View Modal -->
    <div class="modal fade" id="viewModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Student Details</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="viewBody"></div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- App Script -->
    <script>
      // ===================== GLOBALS =====================
      let students = [];
      const tbody = document.getElementById("studentTbody");
      const studentForm = document.getElementById("studentForm");
      const studentModal = new bootstrap.Modal(
        document.getElementById("studentModal")
      );
      const viewModal = new bootstrap.Modal(
        document.getElementById("viewModal")
      );
      const modalTitle = document.getElementById("modalTitle");
      const studentCountElement = document.getElementById("studentCount");
      let editId = null;

      // ===================== SIMPLE MESSAGE =====================
      function showMessage(message) {
        alert(message);
      }

      // ===================== DATE =====================
      function updateDate() {
        const now = new Date();
        const options = {
          weekday: "long",
          day: "numeric",
          month: "long",
          year: "numeric",
        };
        const formattedDate = now.toLocaleDateString("en-GB", options);
        const dateElement = document.getElementById("currentDate");
        if (dateElement) dateElement.textContent = formattedDate;
      }
      updateDate();

      // ===================== FILTER EVENTS =====================
      document
        .getElementById("yearFilter")
        .addEventListener("change", applyFilters);
      document
        .getElementById("classFilter")
        .addEventListener("change", applyFilters);

      // ===================== LOAD STUDENTS =====================
      async function loadStudentList() {
        try {
          const res = await fetch("http://localhost:5000/api/students");
          students = await res.json();
          renderList();
        } catch (err) {
          console.error(err);
          showMessage("Error loading student list");
        }
      }

      // ===================== FORM SUBMIT =====================
      studentForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData();
        const fileInput = document.getElementById("fPhoto");
        if (fileInput && fileInput.files[0]) {
          formData.append("image", fileInput.files[0]);
        }
        formData.append(
          "studentId",
          document.getElementById("fStudentId").value.trim()
        );
        formData.append("name", document.getElementById("fName").value.trim());
        formData.append(
          "class",
          document.getElementById("fClass").value.trim()
        );
        formData.append("year", document.getElementById("fYear").value.trim());
        formData.append(
          "department",
          document.getElementById("fDepartment").value.trim()
        );
        formData.append(
          "parentName",
          document.getElementById("fParentName").value.trim()
        );
        formData.append(
          "contact",
          document.getElementById("fContact").value.trim()
        );

        var url;
        var method;
        if (editId) {
          url = "http://localhost:5000/api/students/" + editId;
          method = "PUT";
        } else {
          url = "http://localhost:5000/api/students/add";
          method = "POST";
        }

        try {
          const res = await fetch(url, { method: method, body: formData });
          const result = await res.json();
          if (!res.ok) {
            showMessage(result.error || "Error saving student");
            return;
          }

          if (editId) {
            showMessage("Student updated successfully!");
          } else {
            showMessage("Student added successfully!");
          }

          editId = null;
          studentForm.reset();
          studentModal.hide();
          await loadStudentList();
        } catch (err) {
          console.error(err);
          showMessage("Server error while saving student");
        }
      });

      // ===================== FILTER APPLY =====================
      function applyFilters() {
        const yearFilter = document
          .getElementById("yearFilter")
          .value.toLowerCase();
        const classFilter = document
          .getElementById("classFilter")
          .value.toLowerCase();

        const filteredStudents = students.filter(function (student) {
          const studentYear = (student.year || "").toLowerCase();
          const studentClass = (student.class || "").toLowerCase();

          const yearMatch = yearFilter === "all" || studentYear === yearFilter;
          const classMatch =
            classFilter === "all" || studentClass === classFilter;
          return yearMatch && classMatch;
        });

        renderFilteredList(filteredStudents);
      }

      // ===================== RENDER FILTERED LIST =====================
      function renderFilteredList(filteredStudents) {
        tbody.innerHTML = "";

        if (filteredStudents.length === 0) {
          tbody.innerHTML =
            "<tr>" +
            '<td colspan="9" class="text-center py-4">' +
            '<i class="bi bi-inbox" style="font-size: 3rem; color: #9ca3af"></i>' +
            '<p class="mt-2 text-muted">No students found matching the selected filters</p>' +
            "</td>" +
            "</tr>";
          studentCountElement.textContent = "0";
          return;
        }

        filteredStudents.forEach(function (s) {
          const tr = document.createElement("tr");
          const photoSrc = s.image
            ? "http://localhost:5000/uploads/" + s.image
            : "https://via.placeholder.com/40";

          tr.innerHTML =
            '<td><img src="' +
            photoSrc +
            '" class="student-photo" alt="Student photo"></td>' +
            "<td>" +
            s.studentId +
            "</td>" +
            "<td>" +
            s.name +
            "</td>" +
            "<td>" +
            s.class +
            "</td>" +
            "<td>" +
            s.year +
            "</td>" +
            "<td>" +
            s.department +
            "</td>" +
            "<td>" +
            s.parentName +
            "</td>" +
            "<td>" +
            s.contact +
            "</td>" +
            '<td class="action-buttons">' +
            '<button class="btn btn-info btn-sm" onclick="viewStudent(\'' +
            s._id +
            "')\">View</button>" +
            '<button class="btn btn-warning btn-sm" onclick="editStudent(\'' +
            s._id +
            "')\">Edit</button>" +
            '<button class="btn btn-danger btn-sm" onclick="deleteStudent(\'' +
            s._id +
            "')\">Delete</button>" +
            "</td>";

          tbody.appendChild(tr);
        });

        studentCountElement.textContent = String(filteredStudents.length);
      }

      // ===================== RENDER FULL LIST =====================
      function renderList() {
        document.getElementById("yearFilter").value = "all";
        document.getElementById("classFilter").value = "all";
        tbody.innerHTML = "";

        if (students.length === 0) {
          tbody.innerHTML =
            "<tr>" +
            '<td colspan="9" class="text-center py-4">' +
            '<i class="bi bi-inbox" style="font-size: 3rem; color: #9ca3af"></i>' +
            '<p class="mt-2 text-muted">No students added yet. Click New Student to add one!</p>' +
            "</td>" +
            "</tr>";
          studentCountElement.textContent = "0";
          return;
        }

        students.forEach(function (s) {
          const tr = document.createElement("tr");
          const photoSrc = s.image
            ? "http://localhost:5000/uploads/" + s.image
            : "https://via.placeholder.com/40";

          tr.innerHTML =
            '<td><img src="' +
            photoSrc +
            '" class="student-photo" alt="Student photo"></td>' +
            "<td>" +
            s.studentId +
            "</td>" +
            "<td>" +
            s.name +
            "</td>" +
            "<td>" +
            s.class +
            "</td>" +
            "<td>" +
            s.year +
            "</td>" +
            "<td>" +
            s.department +
            "</td>" +
            "<td>" +
            s.parentName +
            "</td>" +
            "<td>" +
            s.contact +
            "</td>" +
            '<td class="action-buttons">' +
            '<button class="btn btn-info btn-sm" onclick="viewStudent(\'' +
            s._id +
            "')\">View</button>" +
            '<button class="btn btn-warning btn-sm" onclick="editStudent(\'' +
            s._id +
            "')\">Edit</button>" +
            '<button class="btn btn-danger btn-sm" onclick="deleteStudent(\'' +
            s._id +
            "')\">Delete</button>" +
            "</td>";

          tbody.appendChild(tr);
        });

        studentCountElement.textContent = String(students.length);
      }

      // ===================== VIEW STUDENT =====================
      window.viewStudent = async function (id) {
        try {
          const res = await fetch("http://localhost:5000/api/students/" + id);
          const s = await res.json();
          if (!res.ok) {
            showMessage(s.error || "Unable to load student");
            return;
          }

          const photoSrc = s.image
            ? "http://localhost:5000/uploads/" + s.image
            : "https://via.placeholder.com/120";

          document.getElementById("viewBody").innerHTML =
            '<div class="text-center mb-3">' +
            '<img src="' +
            photoSrc +
            '" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover" alt="Student photo">' +
            "</div>" +
            '<div class="mb-2"><strong>Student ID</strong> ' +
            s.studentId +
            "</div>" +
            '<div class="mb-2"><strong>Name</strong> ' +
            s.name +
            "</div>" +
            '<div class="mb-2"><strong>Class</strong> ' +
            s.class +
            "</div>" +
            '<div class="mb-2"><strong>Year</strong> ' +
            s.year +
            "</div>" +
            '<div class="mb-2"><strong>Department</strong> ' +
            s.department +
            "</div>" +
            '<div class="mb-2"><strong>Parent Name</strong> ' +
            s.parentName +
            "</div>" +
            '<div class="mb-2"><strong>Contact</strong> ' +
            s.contact +
            "</div>";

          viewModal.show();
        } catch (err) {
          console.error(err);
          showMessage("Error loading details");
        }
      };

      // ===================== EDIT STUDENT =====================
      window.editStudent = async function (id) {
        try {
          const res = await fetch("http://localhost:5000/api/students/" + id);
          const s = await res.json();
          if (!res.ok) {
            showMessage(s.error || "Unable to load student");
            return;
          }

          editId = id;
          modalTitle.textContent = "Edit Student";
          document.getElementById("fStudentId").value = s.studentId || "";
          document.getElementById("fName").value = s.name || "";
          document.getElementById("fClass").value = s.class || "";
          document.getElementById("fYear").value = s.year || "";
          document.getElementById("fDepartment").value = s.department || "";
          document.getElementById("fParentName").value = s.parentName || "";
          document.getElementById("fContact").value = s.contact || "";

          studentModal.show();
        } catch (err) {
          console.error(err);
          showMessage("Error loading student for edit");
        }
      };

      // ===================== DELETE STUDENT =====================
      window.deleteStudent = async function (id) {
        const ok = confirm("Are you sure you want to delete this student?");
        if (!ok) return;

        try {
          const res = await fetch("http://localhost:5000/api/students/" + id, {
            method: "DELETE",
          });
          const result = await res.json();
          if (!res.ok) {
            showMessage(result.error || "Failed to delete student");
            return;
          }
          showMessage("Student deleted successfully");
          await loadStudentList();
        } catch (err) {
          console.error(err);
          showMessage("Error deleting student");
        }
      };

      // ===================== INITIALIZE =====================
      loadStudentList();
    </script>
  </body>
</html>
