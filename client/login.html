<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Portal</title>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

  <style>
    body {
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100%;
      margin: 0;
      padding: 20px;
    }

    html, body {
      height: 100%;
      width: 100%;
    }

    * {
      box-sizing: border-box;
    }

    .main-wrapper {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .icon {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0px 4px 8px rgba(0,0,0, 0.5);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .title {
      color: #0b3c91;
      margin-top: 10px;
      text-align: center;
      margin-bottom: 10px;
      font-size: 28px;
      font-weight: bold;
    }

    .subtitle {
      color: rgb(82, 82, 82);
      margin-bottom: 20px;
      font-size: 14px;
    }

    .container {
      max-width: 300px;
      padding: 0;
      margin-bottom: 15px;
    }

    .form-label {
      text-align: left;
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }

    .form-control {
      margin-bottom: 15px;
    }

    .login {
      background-color: #0b3d91;
      border-color: #0b3d91;
      font-weight: 600;
    }

    .login:hover {
      background-color: #083070;
      border-color: #083070;
    }

    .register-link {
      margin-top: 20px;
      font-size: 14px;
      color: #666;
    }

    .register-link a {
      color: #0b3d91;
      text-decoration: none;
      font-weight: 600;
    }

    .register-link a:hover {
      text-decoration: underline;
    }

    .building-icon {
      font-size: 60px;
      margin-bottom: 10px;
    }

    .role-card {
      background: #ffffff;
      padding: 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid #ddd;
      margin-bottom: 12px;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .role-card:hover {
      background: #f9f9f9;
      border-color: #0b3d91;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .role-icon {
      font-size: 35px;
      flex-shrink: 0;
    }

    .role-info {
      flex: 1;
    }

    .role-name {
      font-size: 18px;
      font-weight: 600;
      color: #0b3d91;
      margin-bottom: 2px;
    }

    .role-desc {
      font-size: 13px;
      color: #999;
      margin: 0;
    }

    .hidden {
      display: none !important;
    }

    .back-button {
      margin-top: 15px;
      background: transparent;
      color: #0b3d91;
      border: 2px solid #0b3d91;
    }

    .back-button:hover {
      background: #0b3d91;
      color: white;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 14px;
      display: none;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 14px;
      display: none;
    }

    @media (max-width: 480px) {
      .icon { padding: 20px; }
      .title { font-size: 24px; }
      .building-icon { font-size: 50px; }
      .role-name { font-size: 20px; }
    }
  </style>

  <style>@view-transition { navigation: auto; }</style>
  
</head>

<body>
  <div class="main-wrapper" style="width: 100%;">
    <!-- Role Selection Screen -->
    <div id="roleSelection" class="icon">
      <div class="building-icon">üèõÔ∏è</div>
      <h1 class="title">Attendance Portal</h1>
      <p class="subtitle">
        <span id="instituteNameRole">Jeppiaar Institute of Technology</span><br>
        <span id="portalSubtitleRole">Select Your Role</span>
      </p>

      <div class="container" style="padding: 0; margin-top: 25px;">
        <div class="role-card" onclick="showLoginPage('student')">
          <div class="role-icon">üéì</div>
          <div class="role-info">
            <div class="role-name" id="studentRoleTitle">Student</div>
            <p class="role-desc">Student attendance portal</p>
          </div>
        </div>

        <div class="role-card" onclick="showLoginPage('teacher')">
          <div class="role-icon">üë®‚Äçüè´</div>
          <div class="role-info">
            <div class="role-name" id="teacherRoleTitle">Teacher</div>
            <p class="role-desc">Teacher management portal</p>
          </div>
        </div>

        <div class="role-card" onclick="showLoginPage('management')">
          <div class="role-icon">üíº</div>
          <div class="role-info">
            <div class="role-name" id="managementRoleTitle">Principal</div>
            <p class="role-desc">Management dashboard</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Login Form Screen -->
    <div id="loginScreen" class="icon hidden">
      <div class="building-icon">üèõÔ∏è</div>
      <h1 class="title" id="loginTitle">Principal Login</h1>
      <p class="subtitle">
        <span id="instituteName">Jeppiaar Institute of Technology</span><br>
        <span id="portalSubtitle">Registration Portal</span>
      </p>

      <div class="container">
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>

        <!-- LOGIN FORM -->
        <form id="loginForm">
          <div class="form-group">
            <label for="email" class="form-label">
              <span id="emailLabel">Email or Phone Number</span>
              <span style="color: red;">*</span>
            </label>
            <input type="text" class="form-control" id="email"
                   placeholder="üì± Enter Phone or Email" required>
          </div>

          <div class="form-group">
            <label for="password" class="form-label">
              <span id="passwordLabel">Password</span>
              <span style="color: red;">*</span>
            </label>
            <input type="password" class="form-control" id="password"
                   placeholder="üîí Enter Password" required>
          </div>

          <!-- Selected role (student / teacher / management) -->
          <input type="hidden" id="selectedRole" value="management">

          <button type="submit"
                  class="login btn btn-primary active btn-block">
            <span id="loginButton">Login</span>
          </button>
        </form>

        <button class="btn btn-block back-button" onclick="backToRoles()">
          ‚Üê Back to Roles
        </button>
      </div>
    </div>
  </div>

  <!-- MAIN SCRIPT: LOGIN + GEO-FENCE AUTO CHECK-IN -->
  <script>
    const API_BASE = 'http://localhost:5000';

    const roleSelection = document.getElementById('roleSelection');
    const loginScreen = document.getElementById('loginScreen');
    const loginTitle = document.getElementById('loginTitle');
    const portalSubtitle = document.getElementById('portalSubtitle');
    const selectedRoleInput = document.getElementById('selectedRole');

    const loginForm = document.getElementById('loginForm');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const errorBox = document.getElementById('errorMessage');
    const successBox = document.getElementById('successMessage');

    // -------- ROLE SELECTION UI --------
    function showLoginPage(role) {
      selectedRoleInput.value = role;

      if (role === 'student') {
        loginTitle.textContent = 'Student Login';
        portalSubtitle.textContent = 'Student Attendance Portal';
      } else if (role === 'teacher') {
        loginTitle.textContent = 'Teacher Login';
        portalSubtitle.textContent = 'Teacher Management Portal';
      } else {
        loginTitle.textContent = 'Principal Login';
        portalSubtitle.textContent = 'Management Dashboard';
      }

      roleSelection.classList.add('hidden');
      loginScreen.classList.remove('hidden');
      errorBox.style.display = 'none';
      successBox.style.display = 'none';
    }

    function backToRoles() {
      loginScreen.classList.add('hidden');
      roleSelection.classList.remove('hidden');
      errorBox.style.display = 'none';
      successBox.style.display = 'none';
      loginForm.reset();
    }

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = 'block';
      successBox.style.display = 'none';
    }

    function showSuccess(msg) {
      successBox.textContent = msg;
      successBox.style.display = 'block';
      errorBox.style.display = 'none';
    }

    // -------- AUTO GEO CHECK-IN --------
    async function autoGeoCheckin() {
      if (!navigator.geolocation) return;

      const userMobile = localStorage.getItem('userMobile');  // getItem standard [web:104][web:105]
      const userType = localStorage.getItem('userType');
      if (!userMobile || !userType) return;

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const body = {
            facultyMobile: userType === 'faculty' ? userMobile : null,
            studentMobile: userType === 'student' ? userMobile : null,
            location: {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
              accuracy: pos.coords.accuracy,
            },
          };

          try {
            const res = await fetch(API_BASE + '/api/attendance/checkin', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body),
            });
            const data = await res.json();
            console.log('auto checkin:', data.message || res.status);
          } catch (e) {
            console.log('auto checkin error:', e.message);
          }
        },
        (err) => console.log('geo error:', err.message),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    // -------- LOGIN SUBMIT --------
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const identifier = emailInput.value.trim(); // email or phone
      const password = passwordInput.value.trim();
      const role = selectedRoleInput.value;       // student | teacher | management

      if (!identifier || !password) {
        showError('Please enter all fields');
        return;
      }

      try {
        const res = await fetch(API_BASE + '/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identifier, password, role }),
        });
        const data = await res.json();

        if (!res.ok) {
          showError(data.message || 'Invalid credentials');
          return;
        }

        const user = data.user || data; // expect { mobile, name, role }

        // mobile illa na identifier vaachikuvom
        localStorage.setItem('userMobile', user.mobile || identifier); // setItem usage [web:104][web:105]
        localStorage.setItem('userName', user.name || 'User');

        // teacher -> faculty mapping for attendance controller
        const userType =
          role === 'teacher' ? 'faculty' :
          role === 'student' ? 'student' :
          'management';
        localStorage.setItem('userType', userType);

        showSuccess('Login successful. Redirecting...');

        // time window + geofence `attendancecontroller.js` la check aagum
        await autoGeoCheckin();

        // üîπ ROLE-BASED REDIRECT
        if (userType === 'student' || userType === 'faculty') {
          window.location.href = 'attendance.html';  // redirect pattern [web:94][web:97]
        } else {
          window.location.href = 'overview.html';
        }
      } catch (err) {
        console.error(err);
        showError('Server error. Please try again.');
      }
    });
  </script>

  <!-- (existing Cloudflare script if any) -->
</body>
</html>
