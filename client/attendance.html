<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance App</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <style>
      body {
        background-color: #ffffff;
        box-sizing: border-box;
      }
      .filter-label {
        font-weight: 600;
      }
      .btn-apply {
        background-color: #0b3d91;
        color: white;
      }
      /* Input group icon styling */
      .input-group-text {
        background-color: #e9ecef;
        font-size: 1.2rem;
      }
      .sidebar {
        width: 280px;
        min-height: 100vh;
        position: sticky;
        top: 0;
        background-color: #ffffff;
        font-size: 20px;
        flex-shrink: 0;
      }

      .main-content-wrapper {
        flex: 1;
        width: 100%;
        overflow-x: auto;
      }
      .txt {
        color: #6b7280;
        font-size: 18px;
        margin-bottom: 0px;
        padding: 0px;
      }

      h3 {
        font-size: inherit;
        font-weight: inherit;
        margin-bottom: 0px;
      }

      .nav-link {
        padding: 12px 16px;
        border-radius: 8px;
        transition: background-color 0.3s;
      }

      .nav-link:hover {
        background-color: #f3f4f6;
      }

      /* ========== MEDIA QUERIES - RESPONSIVE DESIGN ========== */

      /* Tablets and below (992px and below) */
      @media (max-width: 992px) {
        #wrapper {
          flex-direction: column !important;
        }

        .sidebar {
          width: 100%;
          min-height: auto;
          position: relative;
          margin-bottom: 20px;
        }

        .sidebar h3 {
          font-size: 24px;
        }

        .txt {
          font-size: 16px;
        }

        .nav-link {
          padding: 10px 12px;
          font-size: 18px;
        }

        .container {
          padding-left: 15px;
          padding-right: 15px;
        }

        .row .col-sm-12 h2 {
          font-size: 24px !important;
        }

        .card.me-5 {
          margin-right: 0 !important;
        }
      }

      /* Small tablets (768px and below) */
      @media (max-width: 768px) {
        .sidebar {
          padding: 1rem !important;
        }

        .sidebar h3 {
          font-size: 20px;
          margin-left: 5px !important;
        }

        .txt {
          font-size: 14px;
          margin-left: 5px !important;
        }

        .nav-link {
          font-size: 16px;
          padding: 8px 10px;
        }

        .nav-link i {
          font-size: 16px;
        }

        .row .col-sm-12 h2 {
          font-size: 20px !important;
          margin-top: 10px;
        }

        .card-body .row.g-4 {
          margin-left: 0 !important;
        }

        .col-md-4 {
          padding-left: 12px;
          padding-right: 12px;
        }

        .filter-label {
          font-size: 14px;
        }

        .input-group-text {
          font-size: 1rem;
        }

        .form-control,
        .form-select {
          font-size: 14px;
        }

        .d-flex.gap-3 {
          margin-left: 12px !important;
          flex-wrap: wrap;
        }

        .btn {
          font-size: 14px;
          padding: 8px 16px;
        }

        .card-title {
          font-size: 18px !important;
        }

        .table {
          font-size: 14px;
        }

        .table th,
        .table td {
          padding: 8px;
        }
      }

      /* Mobile devices (576px and below) */
      @media (max-width: 576px) {
        .sidebar {
          padding: 0.75rem !important;
          font-size: 16px;
        }

        .sidebar h3 {
          font-size: 18px;
        }

        .txt {
          font-size: 12px;
          margin-bottom: 10px !important;
        }

        .nav-link {
          font-size: 14px;
          padding: 8px;
        }

        .nav-link i {
          font-size: 14px;
          margin-right: 8px !important;
        }

        .container {
          padding-left: 10px;
          padding-right: 10px;
        }

        .row .col-sm-12 {
          margin-top: 15px !important;
        }

        .row .col-sm-12 h2 {
          font-size: 18px !important;
          line-height: 1.4;
        }

        .card {
          margin-right: 0 !important;
          border-radius: 8px !important;
        }

        .card-body {
          padding: 1rem;
        }

        .card-body .row.g-4 {
          margin-left: 0 !important;
          gap: 1rem !important;
        }

        .col-md-4 {
          padding-left: 8px;
          padding-right: 8px;
        }

        .filter-label {
          font-size: 13px;
          margin-bottom: 6px;
        }

        .input-group-text {
          font-size: 0.9rem;
          padding: 6px 10px;
        }

        .form-control,
        .form-select {
          font-size: 13px;
          padding: 8px;
        }

        small.text-muted {
          font-size: 11px;
        }

        .d-flex.gap-3 {
          margin-left: 8px !important;
          gap: 0.5rem !important;
          flex-direction: column;
          align-items: stretch;
        }

        .btn {
          font-size: 13px;
          padding: 8px 12px;
          width: 100%;
        }

        .btn i {
          font-size: 13px;
        }

        #outputMsg {
          font-size: 13px;
          margin-left: 10px;
        }

        .card-title {
          font-size: 16px !important;
          margin-bottom: 15px !important;
        }

        .table-responsive {
          font-size: 12px;
        }

        .table th,
        .table td {
          padding: 6px 4px;
          font-size: 12px;
        }

        .table thead th {
          font-size: 12px;
        }
      }

      /* Extra small mobile devices (400px and below) */
      @media (max-width: 400px) {
        .sidebar h3 {
          font-size: 16px;
        }

        .txt {
          font-size: 11px;
        }

        .nav-link {
          font-size: 13px;
          padding: 6px;
        }

        .row .col-sm-12 h2 {
          font-size: 16px !important;
        }

        .filter-label {
          font-size: 12px;
        }

        .input-group-text {
          font-size: 0.8rem;
          padding: 6px 8px;
        }

        .form-control,
        .form-select {
          font-size: 12px;
          padding: 6px;
        }

        .btn {
          font-size: 12px;
          padding: 6px 10px;
        }

        .card-title {
          font-size: 14px !important;
        }

        .table th,
        .table td {
          padding: 4px 2px;
          font-size: 11px;
        }

        .table thead th {
          font-size: 11px;
        }
      }
    </style>
    <style>
      @view-transition {
        navigation: auto;
      }
    </style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
    <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
  </head>
  <body>
    <body>
  <script>
    const userType = localStorage.getItem("userType");

    // Login pannaama na attendance page-ku varakoodadhu
    if (!userType) {
      window.location.href = "login.html";
    }

    // Page load aana udane sidebar handle pannalam
    window.addEventListener("DOMContentLoaded", () => {
      const sidebar = document.querySelector(".sidebar");
      if (!sidebar) return;

      // Student or faculty na sidebar hide
      if (userType === "student" || userType === "faculty") {
        sidebar.style.display = "none";
      }
      // userType === 'management' na onnum pannave vendam → sidebar visible
    });
  </script>

    <div class="d-flex" id="wrapper" style="background-color: #f7fafc">
      <div class="text-black p-4 sidebar card">
        <h3 class="p-1" style="margin-left: 10px">e-Haazri</h3>
        <p class="txt" style="margin-left: 10px">College Dashboard</p>

        <hr />

        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link text-black" href="overview.html"
              ><i class="bi bi-house-door-fill me-2"></i>Overview</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link text-black" href="student.html"
              ><i class="bi bi-people-fill me-2"></i>Students</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link text-black" href="faculty.html"
              ><i class="bi bi-person-badge-fill me-2"></i>Faculty</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link text-black" href="attendance.html"
              ><i class="bi bi-calendar-check-fill me-2"></i>Attendance</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link text-black" href="login.html"
              ><i class="bi bi-box-arrow-right me-2"></i>Logout</a
            >
          </li>
        </ul>
      </div>
      <div class="container" style="margin-left: 20px">
        <div class="row">
          <div class="col-sm-12 mt-4 mb-3">
            <h2 style="color: #000000; font-weight: 500; font-size: 30px">
              Jeppiaar Institute of Technology Attendance Management
            </h2>
          </div>
        </div>
        <br />
        <div
          class="card shadow-sm border-0 mb-4 me-5"
          style="border-radius: 10px"
        >
          <div class="card-body">
            <div class="row g-4 mb-3 ms-3">
              <!-- Date -->
              <div class="col-md-4">
                <label class="form-label filter-label">Select Date</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="bi bi-calendar"></i
                  ></span>
                  <input
                    type="date"
                    class="form-control"
                    id="dateInput"
                    max="2025-12-12"
                  />
                </div>
                <small class="text-muted">Choose a date up to today.</small>
              </div>
              <!-- Person Type -->
              <div class="col-md-4">
                <label class="form-label filter-label">Person Type</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="bi bi-person-badge"></i
                  ></span>
                  <select class="form-select" id="personType">
                    <option>All</option>
                    <option>Student</option>
                    <option>Faculty</option>
                  </select>
                </div>
              </div>

              <!-- Student Class -->
              <div class="col-md-4">
                <label class="form-label filter-label">Student Class</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="bi bi-building"></i
                  ></span>
                  <select class="form-select" id="studentClass">
                    <option>All Classes</option>
                    <option>A</option>
                    <option>B</option>
                    <option>C</option>
                  </select>
                </div>
              </div>
            </div>
            <!-- Buttons -->
            <div class="d-flex gap-3" style="margin-left: 30px">
              <button class="btn btn-apply" onclick="applyFilters()">
                <i class="bi bi-funnel"></i> Apply Filters
              </button>
              <button
                class="btn btn-outline-secondary px-4"
                onclick="resetFilters()"
              >
                <i class="bi bi-arrow-counterclockwise"></i> Reset Filters
              </button>
            </div>
          </div>
        </div>
        <br /><!-- Output -->
        <div class="mt-4 text-danger fw-semibold" id="outputMsg"></div>
        <div
          class="card shadow-sm border-0 ms-1 me-5"
          style="border-radius: 10px"
        >
          <div class="card-body">
            <h5 class="card-title fw-bold mb-3" id="attendanceHeading">
              Attendance Records
            </h5>
            <div class="table-responsive">
              <table class="table table-bordered align-middle text-center">
                <thead class="table">
                  <tr>
                    <th style="background-color: #0b3d91; color: white">
                      Name &amp; ID
                    </th>
                    <th style="background-color: #0b3d91; color: white">
                      Person Type
                    </th>
                    <th style="background-color: #0b3d91; color: white">
                      Check-in Time
                    </th>
                    <th style="background-color: #0b3d91; color: white">
                      Check-out Time
                    </th>
                  </tr>
                </thead>
                <tbody id="attendanceBody">
                  <tr>
                    <td colspan="4" class="text-danger fw-semibold">
                      No attendance records found for the selected filters.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div
          class="alert card alert-info mt-4 ms-1 me-5"
          style="background-color: #ffffff"
        >
          ✅ Check-in available between <strong>7:30–9:00 AM</strong><br />
          ✅ Checkout available between <strong>3:00–4:00 PM</strong>
        </div>
      </div>

      <script>
        function applyFilters() {
          const date = document.getElementById("dateInput").value;
          const type = document.getElementById("personType").value;
          const cls = document.getElementById("studentClass").value;

          const formattedDate = date
            ? new Date(date).toLocaleDateString("en-GB") // dd/mm/yyyy
            : "";

          // Update heading
          const heading = document.getElementById("attendanceHeading");
          heading.innerText = formattedDate
            ? `Attendance Records (${formattedDate})`
            : "Attendance Records";

          // Output message
          if (!date || (type === "All" && cls === "All Classes")) {
            document.getElementById("outputMsg").innerText =
              "No records found for the selected filters.";
          } else {
            document.getElementById("outputMsg").innerText =
              "Showing filtered results...";
          }

          // Optional: clear table or show fallback
          document.getElementById("attendanceBody").innerHTML = `
      <tr>
        <td colspan="4" class="text-danger fw-semibold">
          No attendance records found for the selected filters.
        </td>
      </tr>
    `;
        }

        function resetFilters() {
          document.getElementById("dateInput").value = "";
          document.getElementById("personType").value = "All";
          document.getElementById("studentClass").value = "All Classes";
          document.getElementById("outputMsg").innerText = "";

          // Reset heading
          document.getElementById("attendanceHeading").innerText =
            "Attendance Records";

          // Reset table
          document.getElementById("attendanceBody").innerHTML = `
      <tr>
        <td colspan="4" class="text-danger fw-semibold">
          No attendance records found for the selected filters.
        </td>
      </tr>
    `;
        }
        // ✅ NEW AUTO CHECK-IN CODE
window.onload = function () {
  const userMobile = localStorage.getItem("userMobile");
  const userType = localStorage.getItem("userType");

  if (!userMobile || !userType) {
    document.getElementById("outputMsg").innerText =
      "Login data missing. Please login again.";
    return;
  }

  if (!navigator.geolocation) {
    document.getElementById("outputMsg").innerText =
      "Geolocation not supported in this browser.";
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async (position) => {
      const body = {
        facultyMobile: userType === "faculty" ? userMobile : null,
        studentMobile: userType === "student" ? userMobile : null,
        location: {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          accuracy: position.coords.accuracy,
        },
      };

      try {
        const res = await fetch(
          "http://localhost:5000/api/attendance/checkin",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          }
        );

        const data = await res.json();
        document.getElementById("outputMsg").innerText = data.message;
        loadAttendanceRecords(); // DB table refresh
      } catch (e) {
        console.log("check-in error:", e.message);
        document.getElementById("outputMsg").innerText =
          "Error during check-in.";
      }
    },
    (err) => {
      console.log("geo error:", err.message);
      document.getElementById("outputMsg").innerText =
        "Location permission denied.";
    },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
};

        
        // Automated checkout based on time window
        async function autoCheckout() {
  const userMobile = localStorage.getItem("userMobile");
  const userType = localStorage.getItem("userType");
  if (!userMobile || !userType) return;

  const body = {
    facultyMobile: userType === "faculty" ? userMobile : null,
    studentMobile: userType === "student" ? userMobile : null,
  };

  try {
    const res = await fetch(
      "http://localhost:5000/api/attendance/checkout",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      }
    );
    const data = await res.json();
    console.log("auto checkout:", data.message || res.status);
    document.getElementById("outputMsg").innerText = data.message;
    loadAttendanceRecords();
  } catch (e) {
    console.log("auto checkout error:", e.message);
  }
}

        // Run auto checkout every 5 minutes
        setInterval(autoCheckout, 300000);
        async function loadAttendanceRecords() {
          const res = await fetch("http://localhost:5000/api/attendance");
          const records = await res.json();
          const tbody = document.getElementById("attendanceBody");
          tbody.innerHTML = "";

          if (records.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-danger fw-semibold">No records found.</td></tr>`;
          } else {
            records.forEach((r) => {
              tbody.innerHTML += `
        <tr>
          <td>${r.studentMobile}</td>
          <td>${r.facultyMobile}</td>
          <td>${
            r.checkInTime ? new Date(r.checkInTime).toLocaleTimeString() : "-"
          }</td>
          <td>${
            r.checkOutTime ? new Date(r.checkOutTime).toLocaleTimeString() : "-"
          }</td>
        </tr>`;
            });
          }
        }
      </script>
      <script>
        // Allowed location (college coordinates)
        const allowedLat = 12.88969;
        const allowedLng = 79.875216;
        const radius = 100; // meters

        // Distance function
        function getDistance(lat1, lng1, lat2, lng2) {
          const R = 6371e3; // meters
          const φ1 = (lat1 * Math.PI) / 180;
          const φ2 = (lat2 * Math.PI) / 180;
          const Δφ = ((lat2 - lat1) * Math.PI) / 180;
          const Δλ = ((lng2 - lng1) * Math.PI) / 180;

          const a =
            Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
            Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

          return R * c; // distance in meters
        }

        // Check location
        navigator.geolocation.getCurrentPosition((pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          const distance = getDistance(lat, lng, allowedLat, allowedLng);

          if (distance <= radius) {
            alert("✅ Inside campus, check-in allowed!");
            // here you call backend API with lat/lng
          } else {
            alert("❌ Outside campus, check-in blocked!");
          }
        });
      </script>
    </div>
    <script>
      async function autoCheckout() {
        const userMobile = localStorage.getItem("userMobile");
        const userType = localStorage.getItem("userType");
        if (!userMobile || !userType) return;

        const body = {
          facultyMobile: userType === "faculty" ? userMobile : null,
          studentMobile: userType === "student" ? userMobile : null,
        };

        try {
          const res = await fetch(
            "http://localhost:5000/api/attendance/checkout",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
            }
          );
          const data = await res.json();
          console.log("auto checkout:", data.message || res.status);
        } catch (e) {
          console.log("auto checkout error:", e.message);
        }
      }

      // Existing logout confirm handler replace pannunga
      document
        .getElementById("confirmLogout")
        .addEventListener("click", async () => {
          await autoCheckout(); // 3–4 pm la success aagum
          localStorage.clear();
          window.location.href = "login.html";
        });

      // baaki overview script code same‑aa irukkattum
    </script>

    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'9aebb0d830667f8b',t:'MTc2NTg2MTk5OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
